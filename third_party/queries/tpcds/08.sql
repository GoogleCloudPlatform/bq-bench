select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '92575','29178','29790','72510','59676','50211',
                          '26188','99334','84423','36773','58621',
                          '67925','45175','20725','98697','51863',
                          '87441','38830','99061','90724','60602',
                          '81865','16322','24855','63529','41260',
                          '49918','91347','60419','64420','16539',
                          '66588','17475','25588','63313','43719',
                          '16008','79144','23442','84580','12968',
                          '64896','66988','36664','27961','57336',
                          '55469','56431','45956','84389','16293',
                          '47455','12167','52378','96155','43931',
                          '75371','26159','71294','47180','67876',
                          '72981','35029','31413','26213','28806',
                          '70086','24701','22703','19895','13707',
                          '11507','97664','11649','35451','76688',
                          '42600','22351','22011','99377','57326',
                          '42103','36902','42458','11000','87787',
                          '83205','58677','64442','20830','66175',
                          '31953','45763','53269','96871','10848',
                          '61777','69656','48080','24663','87879',
                          '67023','10694','18504','41564','42476',
                          '85603','23916','63747','67501','88253',
                          '16600','50873','85621','87310','12688',
                          '48329','11736','91692','64394','30897',
                          '75248','69580','36369','24462','64563',
                          '48760','18917','61094','54347','86926',
                          '80000','36704','39888','93748','11134',
                          '95409','89377','64635','63544','64251',
                          '26047','52344','32379','94781','13825',
                          '32160','92531','44460','51485','88459',
                          '78275','16967','10954','45251','50751',
                          '47640','17462','22777','17405','38507',
                          '83368','89943','97303','16411','74981',
                          '48067','13499','77100','24460','95359',
                          '64833','53733','98300','68509','46177',
                          '76548','64339','72057','85929','30209',
                          '10810','12361','14002','79897','83441',
                          '50549','52152','25520','69273','38311',
                          '81924','51982','69150','22753','50563',
                          '24986','15110','45332','43600','24216',
                          '78974','89756','21618','57533','19022',
                          '70790','28567','59852','11564','49653',
                          '31385','81703','22010','72357','25312',
                          '41848','32697','10252','40676','33362',
                          '54343','75294','12730','27334','65880',
                          '17457','30921','69661','25326','95805',
                          '47035','15698','53541','57682','63829',
                          '12442','39134','72013','37387','61371',
                          '81592','85209','25025','17629','36892',
                          '41503','65927','21757','99213','55757',
                          '35033','29067','18476','32386','51959',
                          '18985','79578','14953','97572','98918',
                          '33542','32419','73598','77050','88586',
                          '86913','45106','63519','95654','42700',
                          '60988','99413','56096','68549','43971',
                          '83030','19774','16173','97563','88713',
                          '14872','72773','52418','23922','11048',
                          '52835','85368','47422','29091','17937',
                          '58036','84042','16069','27450','71709',
                          '48255','65166','59129','15440','31275',
                          '68151','39254','96487','43272','79627',
                          '16190','47172','19826','22397','29730',
                          '20362','44230','27210','14209','92461',
                          '12356','37648','37417','83994','18160',
                          '61678','16059','20314','82484','45977',
                          '52193','40914','53220','23327','26332',
                          '94467','18397','70955','19786','87019',
                          '62325','20557','31426','47579','79208',
                          '75580','17843','75184','15439','31894',
                          '46346','80407','97708','78355','25251',
                          '48758','23386','34493','96429','15745',
                          '16346','27931','12390','56687','38246',
                          '60678','73823','27441','41543','14137',
                          '79461','25154','96369','29230','78329',
                          '57890','15702','95823','73102','50023',
                          '59480','30285','68964','73660','19538',
                          '58556','70596','44150','78179','52823',
                          '27968','14489','27178','68122','66376',
                          '57318','54928','92697','27060','38856',
                          '10622','14144','79927','26515')
     intersect distinct
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;